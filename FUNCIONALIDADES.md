# Funcionalidades

- **Añadir medicamentos**: Con un flujo guiado modular adaptable:
  - **Flujo completo (8 pasos)** para medicamentos con horarios programados:
    - **Paso 1**: Información básica (nombre, tipo de medicamento)
    - **Paso 2**: Tipo de duración del tratamiento (tratamiento continuo, hasta acabar medicación, fechas específicas)
    - **Paso 3**: Fechas del tratamiento (inicio y fin)
    - **Paso 4**: Frecuencia de medicación (todos los días, días específicos de la semana, cada N días, fechas específicas)
    - **Paso 5**: Configuración de dosis (intervalo fijo o dosis personalizadas por día)
    - **Paso 6**: Horario de tomas (definición de horarios y cantidades específicas)
    - **Paso 7**: Configuración de ayuno (opcional: define si requiere ayuno, tipo, duración y notificaciones)
    - **Paso 8**: Cantidad de medicamento (stock inicial y umbral de alerta)
  - **Flujo simplificado (2 pasos)** para medicamentos ocasionales:
    - **Paso 1**: Información básica (nombre, tipo de medicamento)
    - **Paso 2**: Seleccionar "Medicamento ocasional" → salta directamente al paso de cantidad
    - Perfecto para analgésicos, antiácidos, o cualquier medicamento que se tome solo cuando sea necesario
    - No requiere configurar horarios, frecuencias ni fechas
    - **No aparecen en la pantalla principal** (solo en Botiquín)
    - Se registran tocando el medicamento en el Botiquín
- **Tipos de medicamento**: Elige entre diferentes tipos de medicamento, cada uno con su unidad de medida específica:
  - Pastilla, Inyección, Óvulo, Aplicación, Gota, Gramo, Mililitro
- **Programación de horarios y dosis**: Sistema de horarios flexible y potente:
  - **Añade múltiples horarios** para un mismo medicamento
  - **Dosis personalizadas**: Especifica una cantidad diferente para cada horario (ej: 1 pastilla por la mañana, 2 por la noche)
  - **Recordatorios automáticos** en cada horario configurado
  - **Intervalo de dosis fijo**: Define un intervalo de horas y la aplicación calculará los horarios automáticamente
  - **Frecuencia de 24 horas**: El sistema valida que el intervalo sea divisor de 24 horas para mayor precisión
- **Duración del tratamiento**: Define cuánto tiempo tomarás cada medicamento:
  - **Todos los días**: Para tratamientos continuos sin fecha de finalización
  - **Hasta acabar la medicación**: Para tratamientos que terminarán cuando se acabe el medicamento
  - **Fechas específicas**: Selecciona días concretos del calendario en los que tomar el medicamento
  - **Días de la semana**: Define un patrón semanal (ej: lunes, miércoles y viernes)
  - **Cada N días**: Para tratamientos con intervalo de días (ej: cada 2 días, cada 3 días)
  - **Medicamento ocasional (Según necesidad)**: Para medicamentos que se toman solo cuando es necesario, sin horarios programados
    - Flujo simplificado que omite la configuración de horarios, frecuencias y fechas
    - Ideal para analgésicos, antiácidos, medicamentos para síntomas puntuales, etc.
    - Se registran manualmente cada vez que se toman
- **Control de fechas del tratamiento**: Sistema flexible para definir inicio y fin
  - **Fecha de inicio**: Define cuándo comenzar el tratamiento (el medicamento aparece como "pendiente" hasta esa fecha)
  - **Fecha de fin**: Define cuándo termina el tratamiento (el medicamento se marca como "finalizado" después de esa fecha)
  - **Progreso del tratamiento**: Visualización del día actual y días restantes
  - **Totalmente opcional**: Si no defines fechas, el tratamiento continúa indefinidamente según el tipo de duración elegido
- **Registro de tomas**: Sistema completo e inteligente para registrar cuando tomas tus medicamentos
  - **Registro programado**: Para medicamentos con horarios configurados
    - Botón "Registrar toma" accesible desde cada medicamento
    - Selección del horario específico que acabas de tomar
    - Sistema inteligente de tomas restantes:
      - Rastrea qué tomas ya se han tomado hoy
      - Solo muestra las tomas pendientes del día actual
      - Registro automático si solo queda una toma pendiente
      - Mensaje de confirmación al completar todas las tomas del día
    - Descuento automático de stock según la cantidad específica de cada toma
    - Validación de stock disponible para la dosis específica antes de permitir el registro
    - Validación de tomas disponibles (no permite registrar más tomas de las programadas)
    - Confirmación visual con stock restante y tomas pendientes
    - Reprogramación automática de notificaciones tras cada registro
  - **Registro manual**: Para medicamentos "según necesidad" o sin medicación activa
    - Botón "Registrar toma manual" para medicamentos suspendidos, sin horarios, o fuera de su calendario
    - Diálogo para introducir la cantidad exacta tomada
    - Registro en el historial con la hora actual
    - Descuento automático de stock según la cantidad introducida
    - Perfecto para analgésicos, antiácidos, medicamentos esporádicos, etc.
- **Gestión de stock (Pastillero)**: Control completo del inventario de medicamentos
  - Registra la cantidad disponible de cada medicamento con unidades específicas (pastillas, ml, gramos, óvulos, aplicaciones, gotas)
  - Pantalla dedicada "Pastillero" con vista general del inventario
  - Indicadores visuales de estado: disponible (verde), stock bajo (naranja), sin stock (rojo)
  - Cálculo automático de duración estimada:
    - **Medicamentos programados**: Se basa en la dosis diaria total configurada en los horarios
    - **Medicamentos ocasionales**: Se basa en la cantidad consumida el último día que se utilizó el medicamento
  - Umbral de stock bajo configurable por medicamento: decide con cuántos días de anticipación quieres ser avisado (1-30 días, por defecto 3)
  - Tarjetas resumen con totales, medicamentos con stock bajo y sin stock
- **Botiquín**: Vista completa de inventario de medicamentos
  - Pantalla dedicada "Botiquín" accesible desde el menú FAB
  - Lista alfabética de todos los medicamentos registrados
  - Muestra nombre, tipo y cantidad disponible de cada medicamento
  - Indicadores visuales de stock con códigos de color (verde/naranja/rojo)
  - **Modal de acciones rápidas**:
    - Acceso directo al tocar cualquier tarjeta de medicamento
    - Interfaz limpia sin botones adicionales en las tarjetas
    - Muestra información del medicamento y stock actual
    - Opciones disponibles según el estado del medicamento:
      - **Reanudar medicación**: Para medicamentos suspendidos (reactiva notificaciones)
      - **Registrar toma**: Para medicamentos ocasionales que no están suspendidos
      - **Recargar medicamento**: Para todos los medicamentos
      - **Editar medicamento**: Para modificar cualquier aspecto del medicamento
      - **Eliminar medicamento**: Para eliminar permanentemente el medicamento y su historial
    - Experiencia consistente e intuitiva para todos los medicamentos
    - Confirmación de seguridad antes de eliminar
  - **Recarga de stock**:
    - Diálogo intuitivo que muestra el stock actual
    - Sugerencia automática basada en la última recarga
    - Unidades específicas según el tipo de medicamento
    - Actualización inmediata del stock y confirmación visual
  - **Registro de medicamentos ocasionales**:
    - Los medicamentos "según necesidad" solo aparecen en el Botiquín (no en pantalla principal)
    - Muestra indicador visual "Toca para registrar" en medicamentos ocasionales activos
    - Toca la tarjeta para abrir el modal con las opciones disponibles
    - Diálogo para introducir la cantidad exacta tomada
    - Registro automático en el historial con hora actual
    - Descuento automático del stock según la cantidad introducida
    - Cálculo inteligente de stock bajo basado en consumo real
  - Buscador integrado para filtrar medicamentos por nombre
  - Búsqueda case-insensitive (no distingue mayúsculas/minúsculas)
  - Botón de borrado rápido en el buscador
  - Pull-to-refresh para recargar el inventario
  - Estados vacíos informativos cuando no hay medicamentos o no hay resultados de búsqueda
- **Recarga de medicamentos**: Sistema inteligente para reponer el stock
  - Botón "Recargar medicamento" accesible desde cada medicamento
  - Diálogo intuitivo que muestra el stock actual
  - Sugerencia automática basada en la última recarga
  - El sistema recuerda la cantidad de la última recarga y la muestra como sugerencia en futuras recargas
  - Unidades específicas según el tipo de medicamento (pastillas, ml, gramos, etc.)
  - Actualización automática del stock y confirmación visual
- **Próxima toma**: Visualiza la hora de la siguiente toma de cada medicamento en la lista principal
- **Notificaciones push**: Recibe recordatorios automáticos en cada hora de toma programada
  - Notificaciones locales programadas para cada horario del medicamento
  - Se repiten diariamente a la misma hora
  - Incluyen el nombre y tipo del medicamento
  - Se reprograman automáticamente al editar medicamentos
  - Se cancelan automáticamente al eliminar medicamentos
  - **Cancelación inteligente**: Al registrar una toma manualmente, se cancela automáticamente la próxima notificación pendiente del día para evitar notificaciones innecesarias
  - **Acciones desde notificaciones**: Al tocar una notificación, accedes a una pantalla con tres opciones:
    - **Registrar toma**: Marca la toma como tomada y descuenta del stock
    - **Marcar como no tomada**: Registra que no tomaste la dosis sin descontar stock
    - **Posponer toma**: Programa una notificación única para más tarde sin alterar el horario habitual
  - **Actualización automática**: La pantalla principal se recarga automáticamente cuando vuelves a la app después de registrar una dosis desde una notificación
- **Configuración de ayuno**: Sistema completo para gestionar períodos de ayuno asociados a medicamentos
  - **Configuración por medicamento**: Define si un medicamento requiere ayuno durante el flujo de añadir/editar
  - **Tipo de ayuno**: Especifica si el ayuno es antes o después de tomar el medicamento
  - **Duración personalizable**: Define la duración del ayuno en horas y minutos (ej: 2 horas, 1 hora 30 minutos)
  - **Notificaciones de ayuno inteligentes**:
    - **Ayuno antes**: Notificación programada automáticamente para dejar de comer antes de la toma programada
    - **Ayuno después**: Notificación dinámica que solo se programa cuando **realmente tomas** el medicamento, usando la hora real de la toma (no la programada)
    - Esto evita notificaciones innecesarias de "ya puedes comer" cuando no has tomado el medicamento
  - **Gestión de solapamientos**: El sistema fusiona períodos de ayuno solapados automáticamente, usando las restricciones más estrictas
  - **Edición flexible**: Modifica la configuración de ayuno en cualquier momento desde el menú de edición
  - **Persistencia**: La configuración de ayuno se guarda junto con cada medicamento
- **Historial completo de dosis**: Sistema avanzado de seguimiento de adherencia
  - Registro automático de cada toma con hora programada y hora real
  - Historial persistente de todas las dosis tomadas y omitidas
  - Estadísticas de adherencia al tratamiento:
    - Total de dosis programadas
    - Dosis tomadas y omitidas
    - Porcentaje de adherencia calculado automáticamente
  - Vista cronológica con información detallada:
    - **Hora de registro siempre visible**: Todas las tarjetas del historial muestran la hora real en que se registró la toma
    - Diferencia entre hora programada y hora real cuando no se tomó a tiempo (indicador de adelanto/retraso en minutos)
    - Indicador visual de puntualidad con códigos de color
    - Cantidad específica tomada con unidades
    - Estado visual con colores (verde: tomada, rojo: omitida)
  - Filtros avanzados por rango de fechas y medicamento específico
  - Acceso desde pantalla principal y pantalla de acciones
  - Datos almacenados en tabla dedicada `dose_history` con índices optimizados
- **Edición modular**: Sistema flexible de edición por secciones
  - **Menú de edición**: Selecciona qué aspecto del medicamento deseas modificar
  - **Información básica**: Edita nombre y tipo de medicamento
  - **Duración del tratamiento**: Modifica tipo de duración y fechas
  - **Frecuencia**: Cambia el patrón de frecuencia (diario, semanal, específico)
  - **Horarios y cantidades**: Ajusta los horarios de toma y las dosis específicas
  - **Configuración de ayuno**: Modifica los parámetros de ayuno (tipo, duración, notificaciones)
  - **Cantidad disponible**: Actualiza el stock y el umbral de alerta
  - Cada sección se edita de forma independiente y se guarda inmediatamente
- **Suspensión de medicamentos**: Gestión temporal de tratamientos
  - **Suspender medicamento**: Pausa temporalmente las notificaciones de un medicamento
  - **Visibilidad selectiva**:
    - Los medicamentos suspendidos NO aparecen en el Pastillero (vista de stock activo)
    - Los medicamentos suspendidos NO aparecen en la pantalla principal
    - Los medicamentos suspendidos SÍ aparecen en el Botiquín (inventario completo) con su stock actual e indicador visual
  - **Reactivación**: Reactiva fácilmente el medicamento desde el Botiquín y reprograma todas las notificaciones
  - **Acceso rápido**: Suspender/reactivar desde el menú de acciones de cada medicamento o desde el Botiquín
- **Eliminación**: Elimina medicamentos de tu lista
- **Validación inteligente**:
  - Previene la creación de medicamentos duplicados (case-insensitive)
  - Valida que se seleccione al menos una fecha o día en patrones específicos
  - Valida frecuencias de tomas que dividan 24 horas exactamente
  - Previene horarios duplicados con alertas visuales
  - Valida que las cantidades de stock sean no negativas
- **Interfaz responsiva y adaptativa**:
  - Diseño moderno con Material Design 3
  - Layout adaptable que muestra 3 tipos de medicamento por fila en todos los dispositivos
  - Scroll optimizado para pantallas pequeñas
  - **Navegación adaptativa**:
    - **Móviles en vertical (≤600px)**: NavigationBar inferior con 4 secciones
    - **Tablets (>600px)**: NavigationRail lateral para mejor aprovechamiento del espacio
    - **Modo horizontal**: NavigationRail lateral en cualquier dispositivo
    - Transición automática según el tamaño de pantalla y orientación
  - **Pull-to-refresh**: Arrastra hacia abajo para recargar manualmente la pantalla principal y el Pastillero
- **Visualización detallada**: Cada medicamento muestra su tipo, nombre, duración del tratamiento y próxima toma
- **Indicadores visuales de stock**: Alertas en pantalla principal para medicamentos con problemas de stock
  - Icono rojo de error cuando el medicamento se ha agotado (stock = 0)
  - Icono naranja de advertencia cuando el stock es bajo (según el umbral configurado para cada medicamento)
  - Sin indicador cuando el stock es suficiente
  - Toca el indicador para ver detalles: cantidad exacta y duración estimada en días
- **Soporte multiidioma**: Interfaz internacionalizada con soporte para español e inglés
  - Cambio automático según la configuración del dispositivo
  - Traducciones completas de todas las pantallas principales (Medicación, Pastillero, Botiquín, Historial)
  - Sistema extensible mediante archivos ARB para añadir nuevos idiomas fácilmente
